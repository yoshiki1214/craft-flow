---
alwaysApply: true
---

# Flaskルール

## アーキテクチャ
- MVCパターンの遵守
- Blueprintによるモジュール化
- Application Factoryパターンの採用
- SOLIDの原則に基づく設計
- 依存性注入の活用

## コード構造
- Blueprintごとにディレクトリを分割
- 説明的な変数名と関数名の使用
- 型ヒント（Type Hints）の使用
- 関数は単一責任の原則に従う

## データベース操作
- Flask-SQLAlchemyの使用必須
- 生のSQLクエリの使用は最小限に
- クエリビルダーの適切な活用
- N+1問題への対策必須
- 適切なマイグレーションとシーダーの実装

## セキュリティ
- Flask-WTFによるCSRF対策
- 環境変数による機密情報管理
- XSS対策の必須化（Jinja2の自動エスケープ）
- SQLインジェクション対策（SQLAlchemyのパラメータバインディング）
- パスワードハッシュ化（werkzeug.security）

## パフォーマンス
- Flask-Cachingによるキャッシュ実装
- クエリのチューニング
- データベースインデックスの最適化
- Celeryによる非同期処理

## 認証/認可
- Flask-Loginの活用
- ロールベースのアクセス制御（RBAC）
- セッション管理の適切な実装
- パスワードリセットフローの実装
- デコレータによるアクセス制御

## エラー処理
- カスタムエラーハンドラの実装
- 標準loggingモジュールの活用
- try-except ブロックの適切な使用
- エラーロギングの実装

## Application Factory パターン

```python
# app/__init__.py
from flask import Flask
from flask_sqlalchemy import SQLAlchemy
from flask_migrate import Migrate
from flask_login import LoginManager
import os

db = SQLAlchemy()
migrate = Migrate()
login_manager = LoginManager()

def create_app(config_name='default'):
    app = Flask(__name__, instance_relative_config=True)
    
    # 設定
    app.config['SECRET_KEY'] = os.environ.get('SECRET_KEY', 'dev-secret-key')
    app.config['SQLALCHEMY_DATABASE_URI'] = os.environ.get(
        'DATABASE_URL',
        'sqlite:///' + os.path.join(app.instance_path, 'app.db')
    )
    app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
    
    # instanceフォルダの作成
    try:
        os.makedirs(app.instance_path)
    except OSError:
        pass
    
    # 拡張機能の初期化
    db.init_app(app)
    migrate.init_app(app, db)
    login_manager.init_app(app)
    login_manager.login_view = 'auth.login'
    
    # Blueprintの登録
    from app.routes import main, auth
    app.register_blueprint(main.main_bp)
    app.register_blueprint(auth.auth_bp, url_prefix='/auth')
    
    return app
```

## SQLite設定のポイント
- SQLiteファイルは `instance/app.db` に配置
- `instance_relative_config=True` で instance フォルダを使用
- 環境変数 `DATABASE_URL` で接続先を上書き可能
- 開発時は SQLite、本番では PostgreSQL/MySQL に切り替え可能
