# トラブルシューティングガイド

## 問題1: 複数ファイルを順次アップロードしたが、最後のPDFのみが対象になった

### 原因
同じ`pos_number`と`sale_date`の組み合わせで複数のPDFをアップロードすると、重複チェックにより最初のファイルがスキップされる可能性があります。

### 解決方法

#### 方法1: 上書きオプションを使用
- アップロード画面で「上書きオプション」をチェック
- 新しいPDFの出力日時が古いPDFより新しい場合、上書きされます

#### 方法2: 一度に複数ファイルを選択
- ファイル選択時に複数のPDFを同時に選択（Ctrl+クリック）
- すべてのファイルが一度に処理されます

#### 方法3: 異なるPOSレジまたは営業日のPDFをアップロード
- 異なるPOSレジ番号または営業日のPDFは重複チェックを通過します

## 問題2: PDFファイルをアップロードできず、「処理できたファイルがありませんでした」

### 原因の特定

ターミナルに表示されるデバッグ情報を確認してください：

1. **メタデータ抽出エラー**
   - `[ERROR] メタデータが不足しています`
   - PDFからレジ番号や営業日が抽出できていない

2. **テーブルデータ抽出エラー**
   - `[ERROR] テーブルデータが抽出できませんでした`
   - PDFからテーブルが抽出できていない

3. **有効なレコードなし**
   - `[ERROR] 有効なレコードが生成されませんでした`
   - テーブルデータは抽出できたが、レコードに変換できていない

### 解決方法

#### メタデータが抽出できない場合

PDFのテキスト構造を確認：
```python
# デバッグ用スクリプト
python scripts/debug_pdf.py "POS1.pdf"
```

PDFに以下の情報が含まれているか確認：
- レジ番号: "POS1", "POS 1", "レジ番号: POS1" など
- 営業日: "令和7年11月5日" などの形式
- 出力日時: "令和7年11月6日 17時30分" などの形式

#### テーブルデータが抽出できない場合

1. **Javaの確認**
   ```bash
   java -version
   ```
   `tabula-py`はJavaが必要です。インストールされていない場合はインストールしてください。

2. **PDFの構造確認**
   - PDFがテーブル形式になっているか確認
   - 画像のみのPDFの場合は処理できません

3. **tabula-pyのオプション調整**
   - `app/utils/pdf_processor.py`の`extract_table_data_from_pdf`関数で
   - `lattice`や`stream`オプションを調整

#### 有効なレコードが生成されない場合

1. **テーブル構造の確認**
   - デバッグログで表示されるテーブルデータのサンプルを確認
   - 列の位置が想定と異なる可能性があります

2. **列マッピングの調整**
   - `app/utils/pdf_processor.py`の`parse_sales_data`関数で
   - 実際のPDFの列構造に合わせて調整

## デバッグ方法

### 1. デバッグログの確認

アプリケーションを起動したターミナルで、以下のようなログが表示されます：

```
[DEBUG] ファイルを保存しました: POS1.pdf
[DEBUG] メタデータ抽出結果: {'pos_number': 'POS1', 'sale_date': '2025-11-05', ...}
[DEBUG] テーブルデータ抽出結果: 10行
[DEBUG] 整形後のレコード数: 8
[DEBUG] DB保存結果: {'inserted': 8, 'skipped': 0, 'overwritten': 0}
```

### 2. PDF構造の確認スクリプト

```bash
python scripts/debug_pdf.py "POS1.pdf"
```

このスクリプトで以下を確認できます：
- 抽出されたテキスト
- メタデータの抽出結果
- テーブルデータの構造

### 3. データベースの確認

```bash
sqlite3 instance/app.db
SELECT * FROM pos_sales LIMIT 10;
```

## よくあるエラーと対処法

### "ModuleNotFoundError: No module named 'tabula'"
```bash
pip install tabula-py
```

### "Java not found" または "JRE not found"
Javaをインストールしてください：
- Windows: https://www.java.com/ja/download/
- インストール後、環境変数PATHに追加されているか確認

### "PermissionError: [WinError 32]"
Windows環境で一時ファイルの削除に失敗する場合：
- ファイルが他のプロセスで使用されている可能性
- アプリケーションを再起動してください

