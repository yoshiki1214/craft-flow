# POS機能の動作確認ガイド

実際にPOSレポートPDFをアップロードして動作確認する手順です。

## 事前準備

### 1. アプリケーションの起動

ターミナルで以下のコマンドを実行します：

```bash
python app.py
```

以下のメッセージが表示されれば起動成功です：

```
 * Serving Flask app 'app'
 * Debug mode: on
 * Running on http://127.0.0.1:5000
```

### 2. ブラウザでアクセス

ブラウザで以下のURLにアクセスします：

- **ダッシュボード**: http://localhost:5000/pos/
- **アップロード画面**: http://localhost:5000/pos/upload

## 動作確認手順

### ステップ1: ダッシュボードの確認

1. `http://localhost:5000/pos/` にアクセス
2. 以下の情報が表示されることを確認：
   - 総レコード数: 0（初回は0件）
   - 営業日数: 0
   - POSレジ数: 0
3. 「PDFファイルをアップロード」ボタンが表示されることを確認

### ステップ2: PDFファイルのアップロード

1. 「PDFファイルをアップロード」ボタンをクリック
2. アップロード画面（`http://localhost:5000/pos/upload`）が表示されることを確認
3. 以下の操作を行います：

   **a) ファイルの選択**
   - 「ファイルを選択」をクリック
   - POSレポートPDFファイルを選択（複数選択可）
   - 例: `C:\Users\e-tkh\Downloads\POSデータサンプル1.pdf`

   **b) 上書きオプションの設定（オプション）**
   - 「上書きオプション」チェックボックス
     - ✅ チェック: 同じ営業日・レジ番号のデータが存在し、出力日時が新しい場合に上書き
     - ☐ チェックなし: 重複データはスキップ

   **c) アップロード実行**
   - 「アップロード」ボタンをクリック

### ステップ3: 処理結果の確認

1. アップロード後、自動的にダッシュボードにリダイレクトされます
2. 以下のメッセージが表示されることを確認：
   - ✅ 成功: 「X件のファイルを取り込みました。Y件を新規登録しました。」
   - ⚠️ 重複: 「X件は重複のためスキップしました。」
   - 🔄 上書き: 「X件を上書きしました。」

3. ダッシュボードの統計情報が更新されることを確認：
   - 総レコード数: アップロードしたレコード数
   - 営業日数: アップロードしたPDFの営業日数
   - POSレジ数: アップロードしたPDFのPOSレジ数

### ステップ4: データベースの確認（オプション）

データベースに正しく保存されているか確認するには：

```bash
# SQLiteデータベースを確認
sqlite3 instance/app.db

# テーブル一覧を表示
.tables

# pos_salesテーブルのデータを確認
SELECT * FROM pos_sales LIMIT 10;

# 統計情報を確認
SELECT 
    COUNT(*) as total_records,
    COUNT(DISTINCT sale_date) as unique_dates,
    COUNT(DISTINCT pos_number) as unique_pos
FROM pos_sales;

# 終了
.quit
```

## テストシナリオ

### シナリオ1: 初回アップロード

1. 初めてPDFファイルをアップロード
2. **期待結果**: 
   - 「X件を新規登録しました。」と表示
   - ダッシュボードの統計情報が更新される

### シナリオ2: 重複データのスキップ

1. 同じPDFファイルを再度アップロード（上書きオプションなし）
2. **期待結果**: 
   - 「X件は重複のためスキップしました。」と表示
   - データベースのレコード数は変わらない

### シナリオ3: 上書き処理

1. 同じ営業日・レジ番号のPDFをアップロード（上書きオプションあり）
2. 新しいPDFの出力日時が古いPDFより新しい場合
3. **期待結果**: 
   - 「X件を上書きしました。」と表示
   - データベースのデータが更新される

### シナリオ4: 複数ファイルのアップロード

1. 複数のPDFファイルを同時に選択してアップロード
2. **期待結果**: 
   - すべてのファイルが処理される
   - 処理結果がまとめて表示される

## トラブルシューティング

### エラー: 「ファイルが選択されていません」

- **原因**: ファイルが選択されていない、または空のファイルが送信された
- **対処**: 有効なPDFファイルを選択してください

### エラー: 「処理できたファイルがありませんでした」

- **原因**: PDFファイルの解析に失敗した可能性
- **対処**: 
  - PDFファイルが正しい形式か確認
  - PDFファイルが破損していないか確認
  - ターミナルのエラーメッセージを確認

### エラー: 「ModuleNotFoundError: No module named 'tabula'」

- **原因**: 必要なパッケージがインストールされていない
- **対処**: 
  ```bash
  pip install -r requirements.txt
  ```

### エラー: Java関連のエラー

- **原因**: `tabula-py`はJavaの実行環境（JRE）が必要
- **対処**: Javaをインストールしてください
  - Windows: https://www.java.com/ja/download/
  - インストール後、環境変数PATHにJavaが追加されているか確認

### データが表示されない

1. ブラウザのキャッシュをクリア
2. ページを再読み込み（F5）
3. データベースを直接確認（上記のSQLiteコマンド）

## デバッグモード

アプリケーションはデバッグモードで起動しているため、エラーが発生した場合は：
- ターミナルに詳細なエラーメッセージが表示されます
- ブラウザにもエラー情報が表示されます

## 次のステップ

動作確認が完了したら：

1. **日次集計機能の実装**: `daily_sales`テーブルへの集計処理
2. **データ表示機能の追加**: アップロードしたデータの一覧表示
3. **エクスポート機能**: Excelファイルへの出力

